@(skills: Seq[models.quiz.Skill], questions: Seq[(models.quiz.Question, Set[models.quiz.Skill])], data: Seq[controllers.library.QuestionList.QuestionListResponse])(implicit user: models.user.User, request: Request[AnyContent])

@import com.artclod.play.s
@import controllers.library.QuestionList.formatQuestionListResponse
@import controllers.library.QuestionList.id
@import controllers.library.QuestionList.title
@import controllers.library.QuestionList.titleQuery
@import controllers.library.QuestionList.skillQuery
@import play.api.libs.json.Json
@import helper._

@mainContent("Library") {
  <h1>Welcome to the Calculus Tutor server Question Library</h1>

  <h2> New Question</h2>
  <section>
    <a class="pure-button" href="@controllers.library.routes.LibraryController.createQuestionView()"> Create a new question </a>
  </section>

  <h2> Question List</h2>
  <table class="pure-table pure-table-striped">
    <tr>
      <th>Name</th>
      @for(skill <- skills){<th><span data-ot="@skill.name">@skill.short_name</span></th>}
    </tr>
    @for(question <- questions){
    <tr>
        <td> <a href="@controllers.library.routes.LibraryController.viewQuestion(question._1.id, None)"> @question._1.title </a> </td>
        @for(skill <- skills){<td>@if(question._2.contains(skill)){ @tag.icon("icon-checkmark3") }else{ @tag.icon("icon-cross") }</td>}
    </tr>}
  </table>

  <section id="question-list-search">
    <form method="post" action="/library/query"> @* https://stackoverflow.com/questions/45470802/how-to-pass-along-csrf-token-in-an-ajax-post-request-for-a-form#45490899 *@
      <input data-bind="textInput: @titleQuery" />
      @for(skill <- skills){ <label for="skill_@skill.name"> <input checked="checked" data-bind="checked: @skillQuery" type="checkbox" value="@skill.name" id="skill_@skill.name" > </input> @skill.name </label> }
      <a class="pure-button" href="javascript:QL.runQuery()">Update</a>
      @CSRF.formField
    </form>
  </section>

  <section id="question-list">
    <table class="pure-table pure-table-striped">
      <tr>
        <th>Name</th>
        @for(skill <- skills){<th><span data-ot="@skill.name">@skill.short_name</span></th>}
      </tr>
      <!-- ko foreach: $data -->
      <tr>
        <td> <a data-bind="text : @{title}(), attr: { href: '/library/question/' + @{id}(), title : @{title}() }"> </a> </td>
        @for(skill <- skills){<td data-bind="html : QL.si(skills(),'@skill.name')"> </td>}
      </tr>
      <!-- /ko -->
    </table>
  </section>

  <script type="text/javascript">
    // === The Answer Enhance Module ===
    // it knows how to enhance the view model with the MathJAX computations/displays etc
    var QL = function() {
      // Get the raw data into a var
      var data = @Html(Json.toJson(data).toString);

      // Turn it into a view model
      var viewModel = ko.mapping.fromJS(data);

      // https://stackoverflow.com/questions/16291456/knockout-checkboxes-with-array
      var selectedSkills = ko.observableArray(@Html(skills.map(_.name).mkString("['", "','", "']")));
      var titleQuery = ko.observable("%");
      var searchViewModel = { @skillQuery : selectedSkills, @titleQuery : titleQuery };

      var skillIndicator = function(skillsList, skillName) {
        return skillsList.includes(skillName) ? '@tag.icon("icon-checkmark3")' : '@tag.icon("icon-cross")';
      };

      var skillsNames = @Html(skills.map(_.name).mkString("['", "','", "']"));

      var runQuery = function() {
          console.log("runQuery");

          // https://stackoverflow.com/questions/45470802/how-to-pass-along-csrf-token-in-an-ajax-post-request-for-a-form#45490899
          var token =  $('input[name="csrfToken"]').attr('value')
          $.ajaxSetup({
              beforeSend: function(xhr) {
                  xhr.setRequestHeader('Csrf-Token', token);
              }
          });

          console.log("token");
          console.log(token);




          console.log("ko.mapping.toJS(QL.searchViewModel)");
          console.log(ko.mapping.toJS(QL.searchViewModel));

          console.log("ko.mapping.toJSON(QL.searchViewModel)");
          console.log(ko.mapping.toJSON(QL.searchViewModel));

          console.log("encodeURIComponent(ko.mapping.toJSON(QL.searchViewModel))");
          console.log(encodeURIComponent(ko.mapping.toJSON(QL.searchViewModel)));

          $.ajax({
              dataType: "json",
              url: "/library/query",
              type: "POST",
              contentType: "application/json; charset=utf-8",
              data: JSON.stringify(ko.mapping.toJS(QL.searchViewModel)),
              success: function(data) {
                  console.log("data");
                  console.log(data);
                  var model = ko.mapping.fromJSON(data);
                  var mapping = {};
                  return ko.mapping.fromJS(model, mapping, QL.viewModel);
              }
          });
      };

      var QL = {
        si : skillIndicator,
        skillsNames : skillsNames,
        viewModel : viewModel,
        searchViewModel : searchViewModel,
        runQuery : runQuery
      };
      return QL;
    }();

    // then applying bindings
    ko.applyBindings(QL.viewModel,       document.getElementById("question-list"));
    ko.applyBindings(QL.searchViewModel, document.getElementById("question-list-search"));
  </script>
}
